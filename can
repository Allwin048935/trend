import ccxt
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime
import telegram
import mplfinance as mpf

from config import BINANCE_API_KEY, BINANCE_API_SECRET, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID

# Initialize Binance exchange
exchange = ccxt.binance({
    'apiKey': BINANCE_API_KEY,
    'secret': BINANCE_API_SECRET,
    'enableRateLimit': True,
})

# Parameters
RSI_LENGTH = 9
INNER_MULT = 1.0
PRIMARY_TRENDLINE_LENGTH = 20
SECONDARY_TRENDLINE_LENGTH = 10
MAX_TRENDLINES = 3

# Get BTCUSDT 15m data
def get_ohlcv(symbol='BTCUSDT', timeframe='1h', limit=100):
    ohlcv = exchange.fetch_ohlcv(symbol, timeframe, limit=limit)
    df = pd.DataFrame(ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
    df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')
    df.set_index('timestamp', inplace=True)  # Set timestamp as index for mplfinance
    return df

# RSI calculation
def calculate_rsi(df, length=RSI_LENGTH):
    delta = df['close'].diff()
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    avg_gain = gain.rolling(window=length).mean()
    avg_loss = loss.rolling(window=length).mean()
    rs = avg_gain / avg_loss
    rsi = 50 + 50 * rs / (1 + rs)
    return rsi

def calculate_rsi_channel(rsi, length=RSI_LENGTH):
    rsi_change = rsi.diff().abs()
    return rsi_change.rolling(window=length).std()

# Trendlines (based on price) - Corrected
def find_pivot_points(series, length, left_length):
    pivots_high = pd.Series(index=series.index, dtype=float)
    pivots_low = pd.Series(index=series.index, dtype=float)
    
    for i in range(left_length, len(series) - left_length):
        if series.iloc[i] == max(series.iloc[i-left_length:i+left_length+1]):
            pivots_high.iloc[i] = series.iloc[i]
        if series.iloc[i] == min(series.iloc[i-left_length:i+left_length+1]):
            pivots_low.iloc[i] = series.iloc[i]
    
    return pivots_high, pivots_low

def calculate_trendlines(df, pivots, length, extension=50, max_lines=MAX_TRENDLINES):
    trendlines = []
    pivot_points = pivots.dropna()
    if len(pivot_points) < 2:
        return trendlines
    
    timestamps = df.index  # This is a DatetimeIndex
    last_timestamp = timestamps[-1]
    
    for i in range(1, len(pivot_points)):
        idx1 = pivot_points.index[i-1]  # Timestamp from pivot points
        idx2 = pivot_points.index[i]    # Timestamp from pivot points
        
        # Get the timestamps directly from the index
        x1 = idx1  # Already a datetime
        x2 = idx2  # Already a datetime
        y1 = pivot_points.iloc[i-1]  # Price value
        y2 = pivot_points.iloc[i]    # Price value
        
        time_diff = (x2 - x1).total_seconds() / 3600
        slope = (y2 - y1) / time_diff if time_diff != 0 else 0
        
        x_end = min(timestamps[-1] + pd.Timedelta(minutes=15 * extension), last_timestamp)
        extension_time = (x_end - x2).total_seconds() / 3600
        y_end = y2 + slope * extension_time
        
        trendlines.append({
            'x1': x1, 'y1': y1,
            'x2': x_end, 'y2': y_end,
            'slope': slope
        })
    
    return trendlines[-max_lines:] if len(trendlines) > max_lines else trendlines

# RSI Divergence
def find_divergence(price, rsi):
    divergences = []
    for i in range(2, len(price)-1):
        if (price.iloc[i] < price.iloc[i-1] and rsi.iloc[i] > rsi.iloc[i-1] and 
            price.iloc[i] < price.iloc[i+1] and rsi.iloc[i] > rsi.iloc[i+1]):
            divergences.append(('bullish', i))
        if (price.iloc[i] > price.iloc[i-1] and rsi.iloc[i] < rsi.iloc[i-1] and 
            price.iloc[i] > price.iloc[i+1] and rsi.iloc[i] < rsi.iloc[i+1]):
            divergences.append(('bearish', i))
    return divergences

# Plotting with Candlesticks
def create_chart(df, rsi, rsi_channel, 
                 primary_high_trendlines, primary_low_trendlines,
                 secondary_high_trendlines, secondary_low_trendlines, divergences):
    # Prepare candlestick data
    mpf_data = df[['open', 'high', 'low', 'close']].rename(columns={
        'open': 'Open', 'high': 'High', 'low': 'Low', 'close': 'Close'
    })

    # Create custom market colors and style
    mc = mpf.make_marketcolors(up='#2fc71e', down='#ed2f1a', inherit=True)
    s = mpf.make_mpf_style(base_mpl_style=['bmh', 'dark_background'], marketcolors=mc, y_on_right=True)

    # Prepare trendline plots
    primary_high_plots = [mpf.make_addplot(pd.Series([tl['y1'], tl['y2']], index=[tl['x1'], tl['x2']]), 
                                          color='#cf0a83' if tl['slope'] < 0 else '#027521', 
                                          linestyle='-', linewidth=2) 
                          for tl in primary_high_trendlines]
    primary_low_plots = [mpf.make_addplot(pd.Series([tl['y1'], tl['y2']], index=[tl['x1'], tl['x2']]), 
                                         color='#cf0a83' if tl['slope'] < 0 else '#027521', 
                                         linestyle='-', linewidth=2) 
                         for tl in primary_low_trendlines]
    secondary_high_plots = [mpf.make_addplot(pd.Series([tl['y1'], tl['y2']], index=[tl['x1'], tl['x2']]), 
                                            color='red' if tl['slope'] < 0 else 'green', 
                                            linestyle='--', linewidth=1) 
                           for tl in secondary_high_trendlines]
    secondary_low_plots = [mpf.make_addplot(pd.Series([tl['y1'], tl['y2']], index=[tl['x1'], tl['x2']]), 
                                           color='red' if tl['slope'] < 0 else 'green', 
                                           linestyle='--', linewidth=1) 
                          for tl in secondary_low_trendlines]

    # Prepare divergence plots
    divergence_plots = []
    for div_type, idx in divergences:
        color = 'green' if div_type == 'bullish' else 'red'
        divergence_plots.append(mpf.make_addplot(
            pd.Series([df['close'].iloc[idx-1], df['close'].iloc[idx+1]], 
                      index=[df.index[idx-1], df.index[idx+1]]),
            color=color, linestyle='--', linewidth=2
        ))

    # RSI plot setup
    rsi_plot = mpf.make_addplot(rsi.dropna(), panel=1, color='#A64D79', ylabel='RSI')
    upper_inner = 50 + INNER_MULT * rsi_channel.dropna()
    lower_inner = 50 - INNER_MULT * rsi_channel.dropna()
    upper_inner_plot = mpf.make_addplot(upper_inner, panel=1, color='#A64D79', alpha=0.3)
    lower_inner_plot = mpf.make_addplot(lower_inner, panel=1, color='#A64D79', alpha=0.3)

    # Combine all additional plots
    add_plots = (primary_high_plots + primary_low_plots + secondary_high_plots + secondary_low_plots +
                 divergence_plots + [rsi_plot, upper_inner_plot, lower_inner_plot])

    # Plot using mplfinance
    mpf.plot(
        mpf_data,
        type='candle',
        style=s,
        figratio=(15, 10),
        tight_layout=True,
        datetime_format='%Y-%m-%d %H:%M',
        ylabel='Price ($)',
        addplot=add_plots,
        panel_ratios=(2, 1),  # Price panel larger than RSI panel
        fill_between=dict(y1=lower_inner.values, y2=upper_inner.values, 
                         where=(lower_inner.notna() & upper_inner.notna()), 
                         alpha=0.1, color='#A64D79', panel=1),
        hlines=[{'h': 60, 'color': 'blue', 'linestyle': '--', 'alpha': 0.3, 'panel': 1},
                {'h': 40, 'color': 'red', 'linestyle': '--', 'alpha': 0.3, 'panel': 1}],
        title='BTCUSDT 15m - Price and RSI'
    )

    plt.savefig('rsi_analysis.png', bbox_inches='tight')
    plt.close()

# Send to Telegram
async def send_to_telegram():
    bot = telegram.Bot(token=TELEGRAM_BOT_TOKEN)
    with open('rsi_analysis.png', 'rb') as photo:
        await bot.send_photo(chat_id=TELEGRAM_CHAT_ID, photo=photo)

# Main execution
def main():
    df = get_ohlcv()
    
    rsi = calculate_rsi(df)
    rsi_channel = calculate_rsi_channel(rsi)
    
    # Calculate pivot points using close price
    price_high_pivots, price_low_pivots = find_pivot_points(df['close'], PRIMARY_TRENDLINE_LENGTH, PRIMARY_TRENDLINE_LENGTH//2)
    price_sec_high_pivots, price_sec_low_pivots = find_pivot_points(df['close'], SECONDARY_TRENDLINE_LENGTH, SECONDARY_TRENDLINE_LENGTH//2)
    
    primary_high_trendlines = calculate_trendlines(df, price_high_pivots, PRIMARY_TRENDLINE_LENGTH)
    primary_low_trendlines = calculate_trendlines(df, price_low_pivots, PRIMARY_TRENDLINE_LENGTH)
    secondary_high_trendlines = calculate_trendlines(df, price_sec_high_pivots, SECONDARY_TRENDLINE_LENGTH, 25)
    secondary_low_trendlines = calculate_trendlines(df, price_sec_low_pivots, SECONDARY_TRENDLINE_LENGTH, 25)
    
    divergences = find_divergence(df['close'], rsi)
    
    create_chart(df, rsi, rsi_channel,
                 primary_high_trendlines, primary_low_trendlines,
                 secondary_high_trendlines, secondary_low_trendlines, divergences)
    
    import asyncio
    asyncio.run(send_to_telegram())

if __name__ == "__main__":
    main()